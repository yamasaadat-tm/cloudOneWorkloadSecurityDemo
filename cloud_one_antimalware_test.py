from cloud_one_workload_security_demo_utils import sendheartbeat
import zipfile #importing zipfile module
import wget #bringing wget functionality
import os
import urllib3
from bs4 import BeautifulSoup
import random
import rarfile

def getfile():

    files_url = "http://www.tekdefense.com/downloads/malware-samples/"
    download_base_url = "http://www.tekdefense.com"

    http = urllib3.PoolManager()

    r = http.request('GET', files_url)

    parsed_html = BeautifulSoup(r.data, 'html.parser')

    tempList = parsed_html.body.find_all('h3', attrs={'class': 'title'})

    linksDict = {}

    for link in tempList:

        linksDict.update({link.text: download_base_url + link.find('a').get("href")})

    tempDict = {}

    for link in linksDict.keys():

        if ".exe.zip" not in link:

            tempDict.update({link: linksDict[link]})    
    
    return random.choice(list(tempDict.items()))

# This is the anti-malware test
# It assumes that real-time antimalware is on the system
# It then attempts to download various versions of the eicar file
# If real-time anti-malware is on the system then these tests should trigger events
# The test will also perform a heartbeat to ensure the events get back to 
# Cloud One Workload Security or Deep Security Manager
def antimalwaretest (operating_system):
   
    file = getfile()
    pswd = 'infected'
    

    # Attempt to download the various eicar test files
    print("---Running Anti-Malware Test---")
    filename = file [0]
    fileurl = file[1]
    print("Downloading Malware - ", filename)
    wget.download (fileurl)
    if filename.endswith ('.zip'):
        with zipfile.ZipFile(filename) as file:
            file.extractall (pwd=bytes(pswd, 'utf-8'))
    elif filename.endswith ('.rar'):
        with rarfile.Rarfile (file) as file:
            filename.extractall(pwd='pswd')
    else:
        print('pass')

    #Perform a heartbeat to get the events to Cloud One or Deep Security Manager
    sendheartbeat(operating_system)
    os.remove (filename)

    print ("Remove all Malware Files")